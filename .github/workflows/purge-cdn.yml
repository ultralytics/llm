# Ultralytics ðŸš€ AGPL-3.0 License - https://ultralytics.com/license

# Purge jsdelivr CDN cache when JavaScript files are updated to ensure users get latest versions immediately

name: Purge CDN Cache

on:
  push:
    branches: [main]
    paths:
      - "js/**"
  workflow_dispatch:

permissions:
  contents: read # Read code in repository

jobs:
  purge:
    runs-on: ubuntu-latest
    steps:
      - name: Purge jsdelivr CDN
        run: |
          FILES=(
            "js/chat.js"
            "js/chat.min.js"
          )
          BRANCHES=("main" "master")
          echo "Purging jsdelivr CDN cache for ${{ github.repository }}..."
          for file in "${FILES[@]}"; do
            for branch in "${BRANCHES[@]}"; do
              URL="https://purge.jsdelivr.net/gh/${{ github.repository }}@$branch/$file"
              echo "Purging: $file ($branch)"
              RESPONSE=$(curl -fsSw "\n%{http_code}" "$URL")
              HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
              BODY=$(echo "$RESPONSE" | head -n-1)
              if [ "$HTTP_CODE" -eq 200 ]; then
                echo "âœ“ Success: $file@$branch (HTTP $HTTP_CODE)"
              else
                echo "âœ— Failed: $file@$branch (HTTP $HTTP_CODE)"
                echo "Response: $BODY"
                exit 1
              fi
              sleep 1
            done
          done
          echo "CDN purge complete"
