# Ultralytics ðŸš€ AGPL-3.0 License - https://ultralytics.com/license

# Purge jsdelivr CDN cache when JavaScript files are updated to ensure users get latest versions immediately

name: Purge CDN Cache

on:
  push:
    branches: [main]
    paths:
      - "js/**"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  purge:
    runs-on: ubuntu-latest
    steps:
      - name: Purge jsdelivr CDN
        run: |
          set -e
          FILES=("js/chat.js" "js/chat.min.js")
          VERSIONS=("main" "master" "latest")
          
          echo "Purging jsdelivr CDN cache for ${{ github.repository }}..."
          SUCCESS=0
          FAILED=0
          
          for file in "${FILES[@]}"; do
            for version in "${VERSIONS[@]}"; do
              URL="https://purge.jsdelivr.net/gh/${{ github.repository }}@$version/$file"
              echo "Purging: $file@$version"
              
              # Use curl with error handling
              RESPONSE=$(curl -fsSw "\n%{http_code}" "$URL" 2>&1 || echo -e "\n000")
              HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
              BODY=$(echo "$RESPONSE" | head -n-1)
              
              if [ "$HTTP_CODE" = "200" ]; then
                echo "âœ“ Success: $file@$version (HTTP $HTTP_CODE)"
                ((SUCCESS++))
              else
                echo "âœ— Failed: $file@$version (HTTP $HTTP_CODE)"
                [ -n "$BODY" ] && echo "Response: $BODY"
                ((FAILED++))
              fi
              sleep 1
            done
          done
          
          echo ""
          echo "CDN purge summary: $SUCCESS successful, $FAILED failed"
          
          # Don't fail the workflow if some purges fail (CDN might not have cached yet)
          if [ $SUCCESS -eq 0 ]; then
            echo "Error: All CDN purges failed"
            exit 1
          elif [ $FAILED -gt 0 ]; then
            echo "Warning: Some purges failed but at least one succeeded"
          fi
