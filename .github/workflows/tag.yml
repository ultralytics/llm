# Ultralytics ðŸš€ AGPL-3.0 License - https://ultralytics.com/license

# This workflow automatically publishes a new repository tag and purges jsdelivr CDN cache

name: Tag and Release

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Tag name (e.g., v0.1.0)"
        required: true
        type: string
      publish_tag:
        description: "Publish new tag"
        required: true
        type: boolean
        default: true

jobs:
  tag-and-release:
    if: github.repository == 'ultralytics/llm' && github.actor == 'glenn-jocher'
    name: Tag and Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Git config
        run: |
          git config --global user.name "UltralyticsAssistant"
          git config --global user.email "web@ultralytics.com"

      - name: Check if tag exists
        id: check_tag
        run: |
          if git rev-parse ${{ github.event.inputs.tag_name }} >/dev/null 2>&1; then
            echo "Tag ${{ github.event.inputs.tag_name }} already exists"
            echo "tag_exists=true" >> $GITHUB_OUTPUT
          else
            echo "Tag ${{ github.event.inputs.tag_name }} does not exist"
            echo "tag_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Validate tag format
        if: steps.check_tag.outputs.tag_exists == 'false' && github.event.inputs.publish_tag == 'true'
        run: |
          TAG="${{ github.event.inputs.tag_name }}"
          if ! [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Invalid tag format '$TAG'. Use v0.1.0 format"
            exit 1
          fi

      - name: Publish new tag
        if: steps.check_tag.outputs.tag_exists == 'false' && github.event.inputs.publish_tag == 'true'
        run: |
          git tag -a "${{ github.event.inputs.tag_name }}" -m "Release ${{ github.event.inputs.tag_name }}"
          git push origin "${{ github.event.inputs.tag_name }}"

      - name: Purge jsdelivr CDN cache
        if: steps.check_tag.outputs.tag_exists == 'false' && github.event.inputs.publish_tag == 'true'
        run: |
          set -e
          FILES=("js/chat.js" "js/chat.min.js")
          VERSIONS=("main" "latest" "${{ github.event.inputs.tag_name }}")
          
          echo "Purging jsdelivr CDN cache for ${{ github.repository }}..."
          SUCCESS=0
          FAILED=0
          
          for file in "${FILES[@]}"; do
            for version in "${VERSIONS[@]}"; do
              URL="https://purge.jsdelivr.net/gh/${{ github.repository }}@$version/$file"
              echo "Purging: $file@$version"
              
              RESPONSE=$(curl -fsSw "\n%{http_code}" "$URL" 2>&1 || echo -e "\n000")
              HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
              
              if [ "$HTTP_CODE" = "200" ]; then
                echo "âœ“ Success: $file@$version"
                ((SUCCESS++))
              else
                echo "âœ— Failed: $file@$version (HTTP $HTTP_CODE)"
                ((FAILED++))
              fi
              sleep 1
            done
          done
          
          echo ""
          echo "CDN purge summary: $SUCCESS successful, $FAILED failed"
