class UltralyticsChat{constructor(t={}){this.config={apiUrl:t.apiUrl||"https://chat-885297101091.europe-west1.run.app/api/chat",maxMessageLength:t.maxMessageLength||1e4,branding:{name:t.branding?.name||"AI",tagline:t.branding?.tagline||"Ask anything about Ultralytics, YOLO, and more",logo:t.branding?.logo||"https://cdn.prod.website-files.com/680a070c3b99253410dd3dcf/68e4eb1e9893320b26cc02c3_Ultralytics%20Logo.png.svg",logomark:t.branding?.logomark||"https://storage.googleapis.com/organization-image-assets/ultralytics-botAvatarSrcUrl-1729379860806.svg",pillText:t.branding?.pillText||"Ask AI"},theme:{primary:t.theme?.primary||"#042AFF",dark:t.theme?.dark||"#111F68",yellow:t.theme?.yellow||"#E1FF25",text:t.theme?.text||"#0b0b0f"},welcome:{title:t.welcome?.title||"Hello ðŸ‘‹",message:t.welcome?.message||"I'm an AI assistant trained on Ultralytics documentation - ask me anything!",examples:t.welcome?.examples||["What's new in YOLO11?","How do I get started with YOLO?","Tell me about Enterprise Licensing"]},ui:{placeholder:t.ui?.placeholder||"Ask anythingâ€¦",copyText:t.ui?.copyText||"Copy thread",downloadText:t.ui?.downloadText||"Download thread",clearText:t.ui?.clearText||"New chat"}},this.apiUrl=this.config.apiUrl,this.messages=[],this.isOpen=!1,this.isStreaming=!1,this.abortController=null,this.sessionId=this.loadSessionId(),this.autoScroll=!0,this.mode="chat",this.scrollY=0,this.refs={},this.listeners=new Map,this.inputDebounceTimer=null,this.init()}qs=(t,e=document)=>e.querySelector(t);qsa=(t,e=document)=>[...e.querySelectorAll(t)];on(t,e,s){t&&(t.addEventListener(e,s),this.listeners.has(t)||this.listeners.set(t,[]),this.listeners.get(t).push({ev:e,fn:s}))}el(t,e="",s=""){const a=document.createElement(t);return e&&(a.className=e),s&&(a.innerHTML=s),a}getPageContext(){return{url:window.location.href,title:document.title,description:(t="description",document.querySelector(`meta[name="${t}"]`)?.content||""),path:window.location.pathname};var t}loadSessionId(){try{return localStorage.getItem("ult-chat-session")}catch{return null}}saveSessionId(t){try{localStorage.setItem("ult-chat-session",t)}catch{console.warn("Failed to save session ID")}}init(){this.ensureViewport(),this.createStyles(),this.createUI(),this.attachEvents(),this.syncThemeWithSite(),this.showWelcome(!0),this.updateComposerState(),this.watchForRemoval()}ensureViewport(){let t=document.querySelector('meta[name="viewport"]');t||(t=document.createElement("meta"),t.name="viewport",document.head.appendChild(t)),t.content.includes("maximum-scale")||(t.content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no")}watchForRemoval(){const t=[{element:()=>this.styleElement,parent:document.head},{element:()=>this.refs.pill,parent:document.body},{element:()=>this.refs.modal,parent:document.body},{element:()=>this.refs.backdrop,parent:document.body}],e=new MutationObserver(()=>{t.forEach(({element:t,parent:e})=>{const s=t();s?.parentNode!==e&&e.appendChild(s)})});e.observe(document.head,{childList:!0}),e.observe(document.body,{childList:!0}),this.domObserver=e}destroy(){this.toggle(!1),this.inputDebounceTimer&&clearTimeout(this.inputDebounceTimer),this.domObserver?.disconnect(),this.listeners.forEach((t,e)=>t.forEach(({ev:t,fn:s})=>e.removeEventListener(t,s))),this.listeners.clear(),this.styleElement?.remove(),this.refs.modal?.remove(),this.refs.backdrop?.remove(),this.refs.pill?.remove(),this.refs={}}syncThemeWithSite(){const t=document.documentElement,e=window.matchMedia("(prefers-color-scheme: dark)"),s=()=>{t.hasAttribute("data-theme")||t.setAttribute("data-theme",e.matches?"dark":"light")};s(),e.addEventListener("change",s)}createStyles(){const{primary:t,dark:e,yellow:s,text:a}=this.config.theme;this.styleElement=this.el("style","",`\n      *{box-sizing:border-box}\n      :root{--ult-dark:${e};--ult-primary:${t};--ult-yellow:${s};--ult-text:${a}}\n\n      .ult-backdrop{display:none;position:fixed;inset:0;background:rgba(255,255,255,.07);\n        backdrop-filter:blur(3px) saturate(120%) brightness(1.025);-webkit-backdrop-filter:blur(3px) saturate(120%) brightness(1.025);\n        z-index:9999;opacity:0;transition:opacity .18s}\n      .ult-backdrop.open{display:block;opacity:1}\n\n      .ultralytics-chat-pill{position:fixed;right:16px;bottom:36px;padding:14px 22px;border-radius:9999px;background:var(--ult-yellow);\n        color:var(--ult-dark);border:0;cursor:pointer;font-size:18px;font-weight:500;box-shadow:0 20px 38px rgba(2,6,23,.22),0 8px 18px rgba(2,6,23,.14);\n        z-index:10000;transition:transform .18s,box-shadow .18s,opacity .14s;display:inline-flex;align-items:center;gap:10px;transform:translateZ(0);\n        -webkit-user-select:none;user-select:none;touch-action:manipulation}\n      .ultralytics-chat-pill:hover{transform:scale(1.1)} .ultralytics-chat-pill.hidden{transform:scale(.95);opacity:0;pointer-events:none}\n      .ultralytics-chat-pill img{width:30px;height:30px;border-radius:3px}\n      html[data-theme=dark] .ultralytics-chat-pill{background:#40434f;color:#fff;box-shadow:0 20px 38px rgba(0,0,0,.5),0 8px 18px rgba(0,0,0,.32)}\n\n      .ult-chat-modal{position:fixed;left:50%;top:50%;width:min(760px,calc(100vw - 40px));height:min(80vh,820px);background:#fff;border:0;border-radius:16px;\n        box-shadow:0 24px 60px rgba(2,6,23,.25),0 8px 24px rgba(2,6,23,.18);z-index:10001;transform:translate(-50%,-50%) scale(.98);opacity:0;transition:transform .18s,opacity .18s;\n        flex-direction:column;overflow:hidden;text-align:left;display:none}\n      .ult-chat-modal.open{display:flex;opacity:1;transform:translate(-50%,-50%) scale(1)}\n      html[data-theme=dark] .ult-chat-modal{background:#0a0a0b}\n\n      .ult-chat-header{padding:16px 18px;display:flex;justify-content:space-between;align-items:center}\n      .ult-chat-title{display:flex;align-items:center;gap:10px}\n      .ult-chat-title img{max-height:32px;max-width:180px}\n      .ult-subtle{font-size:12px;color:#6b7280} html[data-theme=dark] .ult-subtle{color:#a1a1aa}\n      .ult-header-actions{display:flex;gap:6px;align-items:center}\n      .ult-icon-btn{background:transparent;border:0;width:44px;height:44px;border-radius:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;color:#6b7280;transition:.15s;touch-action:manipulation}\n      .ult-icon-btn:hover{transform:translateY(-1px);color:var(--ult-text);background:#f7f7f9}\n      html[data-theme=dark] .ult-icon-btn{color:#a1a1aa}\n      html[data-theme=dark] .ult-icon-btn:hover{color:#fafafa;background:#17181d}\n\n      .ult-welcome{padding:18px}.ult-welcome h1{font-size:16px;margin:0 0 6px}.ult-welcome p{margin:0;color:#4b5563}\n      html[data-theme=dark] .ult-welcome p{color:#a1a1aa}\n      .ult-examples{padding:12px 18px 6px;display:flex;flex-wrap:wrap;gap:10px}\n      .ult-example{padding:10px 12px;background:#f7f7f9;border:0;border-radius:999px;cursor:pointer;font-size:12px;color:#0b0b0f;transition:.12s;touch-action:manipulation}\n      .ult-example:hover{transform:translateY(-1px);filter:brightness(.98)}\n      html[data-theme=dark] .ult-example{background:#131318;color:#fafafa}\n\n      .ult-chat-messages{flex:1;overflow-y:auto;padding:0 18px 18px;display:flex;flex-direction:column;gap:14px;-webkit-overflow-scrolling:touch}\n      .ult-message-group{display:flex;flex-direction:column;gap:6px}\n      .ult-message-label{display:flex;align-items:center;gap:8px;font-size:11px;font-weight:800;color:#6b7280;text-transform:uppercase;letter-spacing:.03em;padding:0 2px}\n      html[data-theme=dark] .ult-message-label{color:#a1a1aa}\n      .ult-message-label img{max-height:24px;max-width:24px;border-radius:4px}\n      .ult-user-icon{color:var(--ult-yellow)}\n      .ult-message{font-size:14px;line-height:1.6;color:var(--ult-text);padding:0 2px;word-break:break-word;text-align:left}\n      html[data-theme=dark] .ult-message{color:#f5f5f5}\n      .ult-message a{color:var(--ult-primary);text-underline-offset:2px}.ult-message a:hover{text-decoration:underline}\n      .ult-message strong{font-weight:700;color:var(--ult-text)}\n      html[data-theme=dark] .ult-message strong{color:#fafafa}\n      .ult-message pre{background:#0f172a;color:#e5e7eb;padding:10px 12px;border-radius:10px;overflow:auto;margin:6px 0;border:0}\n      .ult-message code{background:#f4f4f5;padding:2px 6px;border-radius:6px;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:12px;border:0}\n      .ult-message pre code{background:transparent;padding:0;border:0;display:block;color:inherit;font-size:13px}\n      html[data-theme=dark] .ult-message code{background:#1e1e22}\n      html[data-theme=dark] .ult-message pre code{background:transparent}\n\n      .ult-search-result{padding:14px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;margin-bottom:10px;transition:.12s}\n      .ult-search-result:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(2,6,23,.08)}\n      html[data-theme=dark] .ult-search-result{background:#131318;border-color:#232327}\n      .ult-search-result-title{font-size:15px;font-weight:700;margin-bottom:6px;display:flex;align-items:center;gap:8px}\n      .ult-search-result-title a{text-decoration:none;color:var(--ult-primary)}\n      .ult-search-result-favicon{width:18px;height:18px;border-radius:4px;flex-shrink:0;background:#f4f4f5;box-shadow:0 0 0 1px rgba(0,0,0,.05)}\n      html[data-theme=dark] .ult-search-result-favicon{background:#1f1f25;box-shadow:0 0 0 1px rgba(255,255,255,.06)}\n      .ult-search-result-snippet{font-size:13px;line-height:1.5;color:#4b5563;margin-bottom:8px}\n      html[data-theme=dark] .ult-search-result-snippet{color:#a1a1aa}\n      .ult-search-result-meta{display:flex;gap:12px;font-size:11px;color:#9ca3af} html[data-theme=dark] .ult-search-result-meta{color:#71717a}\n\n      .ult-typing{display:inline-flex;gap:4px}\n      .ult-typing span{width:6px;height:6px;background:#a1a1aa;border-radius:50%;animation:ultTyping 1.2s infinite}\n      .ult-typing span:nth-child(2){animation-delay:.18s}.ult-typing span:nth-child(3){animation-delay:.36s}\n      @keyframes ultTyping{0%,60%,100%{transform:translateY(0);opacity:1}30%{transform:translateY(-6px);opacity:.75}}\n      .ult-thinking{display:inline-flex;align-items:center;gap:8px;padding:6px 0;color:#6b7280;font-size:13px}\n      html[data-theme=dark] .ult-thinking{color:#a1a1aa}\n\n      .ult-chat-input-container{padding:12px 12px 16px;display:flex;gap:8px;align-items:flex-end}\n      .ult-actions{display:flex;gap:6px;align-items:center}\n      .ult-action-btn,.ult-chat-send{background:#f1f2f6;border:0;border-radius:12px;width:44px;height:44px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:.12s;flex-shrink:0;touch-action:manipulation;color:#6b7280}\n      .ult-action-btn:hover,.ult-chat-send:hover{transform:translateY(-1px);filter:brightness(.98);color:var(--ult-text)}\n      html[data-theme=dark] .ult-action-btn,html[data-theme=dark] .ult-chat-send{background:#17181d;color:#a1a1aa}\n      html[data-theme=dark] .ult-action-btn:hover,html[data-theme=dark] .ult-chat-send:hover{color:#fafafa}\n      .ult-chat-input{flex:1;padding:10px 12px;border:0;border-radius:12px;font-size:14px;resize:none;max-height:140px;background:#f7f7f9;color:#0b0b0f;outline:0}\n      .ult-chat-input::placeholder{color:#9ca3af} html[data-theme=dark] .ult-chat-input{background:#131318;color:#fafafa}\n\n      .ult-chat-modal[data-mode="search"] .ult-chat-header{order:0}\n      .ult-chat-modal[data-mode="search"] .ult-chat-input-container{order:1;padding:16px 18px;border-top:1px solid #eceff5;border-bottom:1px solid #eceff5;background:#fdfdff;align-items:center}\n      html[data-theme=dark] .ult-chat-modal[data-mode="search"] .ult-chat-input-container{border-color:#1c1c22;background:#0e0e13}\n      .ult-chat-modal[data-mode="search"] #ult-welcome,\n      .ult-chat-modal[data-mode="search"] #ult-examples{order:2;width:100%}\n      .ult-chat-modal[data-mode="search"] .ult-chat-messages{order:3}\n\n      .ult-icon-swap{display:flex;align-items:center;justify-content:center}\n      @media (max-width:768px){\n        .ult-backdrop{pointer-events:none}\n        .ult-chat-modal{position:fixed;left:0;top:0;width:100vw;height:100svh;max-width:100vw;max-height:100svh;border-radius:0;margin:0;padding:0;transform:none!important}\n        .ult-chat-modal.open{transform:none!important;opacity:1}\n        .ult-chat-modal.open{display:flex;flex-direction:column;overflow:hidden}\n        body.ult-modal-open{position:fixed!important;width:100%!important;overflow:hidden!important;-webkit-overflow-scrolling:touch}\n        .ult-actions{display:none}\n        .ult-subtle{display:none!important}\n        .ult-chat-header{padding:8px 12px;min-height:48px;flex-shrink:0;border-bottom:1px solid #eceff5}\n        html[data-theme=dark] .ult-chat-header{border-bottom-color:#1c1c22}\n        .ult-chat-title{gap:6px;flex:1;min-width:0}\n        .ult-chat-title img{max-height:24px;max-width:120px}\n        .ult-header-actions{gap:2px;flex-shrink:0}\n        .ult-icon-btn{width:38px;height:38px;border-radius:8px}\n        .ult-icon-btn svg{width:17px;height:17px}\n        .ult-chat-messages{flex:1 1 0;min-height:0;padding:0 0 8px 0;overflow-y:auto;overflow-x:hidden;overscroll-behavior-y:contain;-webkit-overflow-scrolling:touch}\n        .ult-chat-modal.welcome-mode .ult-chat-messages{display:none}\n        .ult-welcome{padding:10px 14px 0}\n        .ult-welcome h1{font-size:15px;margin:0 0 4px}\n        .ult-welcome p{font-size:13px;margin:0;line-height:1.35}\n        .ult-examples{padding:6px 14px;gap:6px;flex-wrap:wrap}\n        .ult-example{padding:8px 11px;font-size:12px}\n        .ult-chat-input-container{padding:8px 14px 10px;flex:0 0 auto;gap:8px;border-top:1px solid #eceff5;background:#fff}\n        .ult-chat-modal.welcome-mode .ult-chat-input-container{margin-top:auto}\n        html[data-theme=dark] .ult-chat-input-container{border-top-color:#1c1c22;background:#0a0a0b}\n        .ult-chat-input{padding:9px 11px;font-size:16px;max-height:100px;border-radius:10px}\n        .ult-chat-send{width:38px;height:38px;border-radius:10px;flex-shrink:0}\n        .ult-chat-send svg{width:17px;height:17px}\n        .ult-message-group{gap:3px;padding:0 14px;margin-bottom:8px}\n        .ult-message-label{font-size:11px;gap:5px;padding:0;margin-bottom:2px}\n        .ult-message-label img{max-height:20px;max-width:20px}\n        .ult-message-label svg{width:20px;height:20px}\n        .ult-message{font-size:14px;line-height:1.5;padding:0}\n        .ult-message code{font-size:12px;padding:2px 5px}\n        .ult-message pre{padding:8px 10px;font-size:12px;border-radius:8px;margin:4px 0}\n        .ult-search-result{padding:10px;margin-bottom:8px;border-radius:8px}\n        .ult-search-result-title{font-size:14px;margin-bottom:5px}\n        .ult-search-result-snippet{font-size:13px}\n        .ult-search-result-meta{font-size:11px}\n        .ultralytics-chat-pill{right:14px;bottom:28px;padding:12px 18px;font-size:16px}\n        .ultralytics-chat-pill img{width:28px;height:28px}\n      }\n    `),document.head.appendChild(this.styleElement)}icon(t){return`<svg width="18" height="18" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" fill="none">${{copy:'<rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>',download:'<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>',refresh:'<path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>',close:'<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>',like:'<path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/>',dislike:'<path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h2.67A2.31 2.31 0 0 1 22 4v7a2.31 2.31 0 0 1-2.33 2H17"/>',share:'<circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><path d="M8.59 13.51l6.83 3.98"/><path d="M15.41 6.51L8.59 10.49"/>',arrowUp:'<line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/>',square:'<rect x="4.8" y="4.8" width="14.4" height="14.4" rx="2" ry="2"/>'}[t]||""}</svg>`}createUI(){const{logomark:t,pillText:e,logo:s,name:a,tagline:i}=this.config.branding,{title:n,message:o,examples:r}=this.config.welcome,{placeholder:l,copyText:h,downloadText:c,clearText:d}=this.config.ui;this.refs.backdrop=this.el("div","ult-backdrop"),document.body.appendChild(this.refs.backdrop),this.refs.pill=this.el("button","ultralytics-chat-pill",`<span>${this.escapeHtml(e)}</span><img src="${this.escapeHtml(t)}" alt="${this.escapeHtml(a)}" />`),this.refs.pill.setAttribute("aria-label",e),this.refs.pill.title=e,document.body.appendChild(this.refs.pill),this.refs.modal=this.el("div","ult-chat-modal",`\n      <div class="ult-chat-header">\n        <div class="ult-chat-title">\n          <img src="${this.escapeHtml(s)}" alt="${this.escapeHtml(a)}" />\n          <div class="ult-subtle">${this.escapeHtml(i)}</div>\n        </div>\n        <div class="ult-header-actions">\n          <button class="ult-icon-btn ult-chat-copy" title="${this.escapeHtml(h)}" aria-label="${this.escapeHtml(h)}">${this.icon("copy")}</button>\n          <button class="ult-icon-btn ult-chat-download" title="${this.escapeHtml(c)}" aria-label="${this.escapeHtml(c)}">${this.icon("download")}</button>\n          <button class="ult-icon-btn ult-chat-clear" title="${this.escapeHtml(d)}" aria-label="${this.escapeHtml(d)}">${this.icon("refresh")}</button>\n          <button class="ult-icon-btn ult-chat-close" title="Close" aria-label="Close">${this.icon("close")}</button>\n        </div>\n      </div>\n      <div id="ult-welcome" class="ult-welcome" style="display:none">\n        <h1>${this.escapeHtml(n)}</h1><p>${o}</p>\n      </div>\n      <div id="ult-examples" class="ult-examples" style="display:none"></div>\n      <div class="ult-chat-messages" id="ult-messages" aria-live="polite"></div>\n      <div class="ult-chat-input-container">\n        <div class="ult-actions">\n          <button class="ult-action-btn ult-act-copy" title="Copy last response" aria-label="Copy last response">${this.icon("copy")}</button>\n          <button class="ult-action-btn ult-act-like" title="Thumbs up" aria-label="Thumbs up">${this.icon("like")}</button>\n          <button class="ult-action-btn ult-act-dislike" title="Thumbs down" aria-label="Thumbs down">${this.icon("dislike")}</button>\n          <button class="ult-action-btn ult-act-share" title="Share" aria-label="Share">${this.icon("share")}</button>\n          <button class="ult-action-btn ult-act-retry" title="Try again" aria-label="Try again">${this.icon("refresh")}</button>\n        </div>\n        <textarea name="message" class="ult-chat-input" placeholder="${this.escapeHtml(l)}" rows="1" maxlength="${this.config.maxMessageLength}" autocomplete="off"></textarea>\n        <button class="ult-chat-send" title="Ready" aria-label="Ready">\n          <span class="ult-icon-swap" data-icon="square">${this.icon("square")}</span>\n        </button>\n      </div>\n    `),this.refs.modal.setAttribute("role","dialog"),this.refs.modal.setAttribute("aria-modal","true"),document.body.appendChild(this.refs.modal),this.refs.messages=this.qs("#ult-messages",this.refs.modal),this.refs.welcome=this.qs("#ult-welcome",this.refs.modal),this.refs.examples=this.qs("#ult-examples",this.refs.modal),this.refs.input=this.qs(".ult-chat-input",this.refs.modal),this.refs.send=this.qs(".ult-chat-send",this.refs.modal),this.setExamples(r)}setExamples(t){this.refs.examples&&(this.refs.examples.innerHTML=t.map(t=>`<button class="ult-example" data-q="${this.escapeHtml(t)}">${this.escapeHtml(t)}</button>`).join(""),this.qsa(".ult-example",this.refs.examples).forEach(t=>this.on(t,"click",()=>{this.sendMessage(t.dataset.q)})))}attachEvents(){const t=this.refs.modal;this.on(this.refs.pill,"click",()=>this.toggle(!0,"chat")),this.on(this.refs.backdrop,"click",()=>this.toggle()),this.on(this.qs(".ult-chat-close",t),"click",()=>this.toggle()),this.on(this.qs(".ult-chat-clear",t),"click",()=>this.clearSession()),this.on(this.qs(".ult-chat-copy",t),"click",()=>this.copyThread()),this.on(this.qs(".ult-chat-download",t),"click",()=>this.downloadThread()),this.on(this.refs.messages,"scroll",()=>{const t=this.refs.messages;this.autoScroll=t.scrollHeight-t.scrollTop-t.clientHeight<100}),this.on(this.refs.input,"input",t=>{const e=t.target;e.style.height="auto",e.style.height=Math.min(e.scrollHeight,140)+"px",this.inputDebounceTimer&&clearTimeout(this.inputDebounceTimer),this.inputDebounceTimer=setTimeout(()=>this.updateComposerState(),50)}),this.on(this.refs.send,"click",()=>{this.isStreaming?this.stopStreaming():this.sendMessage(this.refs.input.value.trim())}),this.on(this.refs.input,"keydown",t=>{"Enter"!==t.key||t.shiftKey||(t.preventDefault(),this.sendMessage(this.refs.input.value.trim())),"Escape"===t.key&&(t.preventDefault(),this.toggle(!1))}),this.on(document,"keydown",t=>{this.isOpen&&"Escape"===t.key&&this.toggle(!1),!this.isOpen&&t.metaKey&&"k"===t.key.toLowerCase()&&this.toggle(!0)}),this.on(this.qs(".ult-act-copy",t),"click",()=>this.copyLastAssistant()),this.on(this.qs(".ult-act-like",t),"click",()=>this.feedback("up")),this.on(this.qs(".ult-act-dislike",t),"click",()=>this.feedback("down")),this.on(this.qs(".ult-act-share",t),"click",()=>this.copyThread()),this.on(this.qs(".ult-act-retry",t),"click",()=>{this.retryLast()})}toggle(t=null,e=null){const s=null===t?!this.isOpen:!!t;this.isOpen=s,e&&(this.mode=e),this.refs.modal?.classList.toggle("open",s),this.refs.backdrop?.classList.toggle("open",s),this.refs.pill?.classList.toggle("hidden",s),s?(this.scrollY=window.scrollY,document.body.classList.add("ult-modal-open"),document.body.style.top=`-${this.scrollY}px`,this.updateUIForMode(),this.messages.length||this.showWelcome(!0),this.refs.input?.focus(),this.updateComposerState()):(document.body.classList.remove("ult-modal-open"),document.body.style.top="",window.scrollTo(0,this.scrollY),this.isStreaming&&this.stopStreaming())}updateUIForMode(){if(!this.refs.modal)return;const t=this.qs(".ult-subtle",this.refs.modal),e=this.qs(".ult-actions",this.refs.modal);if(this.refs.modal.dataset.mode=this.mode,"search"===this.mode)this.refs.input&&(this.refs.input.placeholder="Search for..."),t&&(t.innerHTML=`<strong style="color: ${this.config.theme.primary}; font-weight: 700;">SEARCH</strong> Â· Find answers in our docs and guides`),e&&(e.style.display="none"),this.refs.messages&&(this.refs.messages.innerHTML=""),this.refs.welcome&&(this.refs.welcome.innerHTML="<p>Enter keywords to find relevant documentation, guides, and resources</p>"),this.setExamples(["YOLO quickstart","model training parameters","export formats","dataset configuration"]),this.showWelcome(!0);else{this.refs.input&&(this.refs.input.placeholder=this.config.ui.placeholder),t&&(t.textContent=this.config.branding.tagline),e&&(e.style.display="");const{title:s,message:a,examples:i}=this.config.welcome;this.refs.welcome&&(this.refs.welcome.innerHTML=`<h1>${this.escapeHtml(s)}</h1><p>${a}</p>`),this.setExamples(i),this.renderChatHistory()}}showWelcome(t){this.refs.welcome&&(this.refs.welcome.style.display=t?"block":"none"),this.refs.examples&&(this.refs.examples.style.display=t?"flex":"none"),this.refs.modal&&this.refs.modal.classList.toggle("welcome-mode",t)}renderChatHistory(){if(!this.refs.messages)return;if(this.refs.messages.innerHTML="",!this.messages.length)return void this.showWelcome(!0);this.showWelcome(!1);const t=this.autoScroll;this.autoScroll=!1,this.messages.forEach(t=>this.addMessageToUI(t.role,t.content)),this.autoScroll=t,this.refs.messages.scrollTop=this.refs.messages.scrollHeight}swapSendIcon(t){const e=this.qs(".ult-icon-swap",this.refs.send);e&&e.dataset.icon!==t&&(e.innerHTML=this.icon(t),e.dataset.icon=t,this.refs.send.title="square"===t&&this.isStreaming?"Stop":"arrowUp"===t?"Send":"Ready",this.refs.send.setAttribute("aria-label",this.refs.send.title))}updateComposerState(){const t=!!this.refs.input?.value.trim().length;this.swapSendIcon(this.isStreaming?"square":t?"arrowUp":"square")}scrollToBottom(){this.autoScroll&&this.refs.messages&&requestAnimationFrame(()=>{this.refs.messages&&(this.refs.messages.scrollTop=this.refs.messages.scrollHeight)})}formatThread(){return this.messages.map(t=>`${"user"===t.role?"You":this.config.branding.name}: ${t.content}`).join("\n\n---\n\n")}copyThread(){navigator.clipboard?.writeText(this.formatThread())?.catch(console.error)}copyLastAssistant(){const t=[...this.messages].reverse().find(t=>"assistant"===t.role);t&&navigator.clipboard?.writeText(t.content)?.catch(console.error)}feedback(t){console.log("feedback:",t)}retryLast(){const t=[...this.messages].reverse().find(t=>"user"===t.role);t&&this.sendMessage(t.content)}downloadThread(){const{name:t}=this.config.branding,e=new Blob([this.formatThread()],{type:"text/plain"}),s=URL.createObjectURL(e),a=this.el("a");a.href=s,a.download=`${t.toLowerCase().replace(/\s+/g,"-")}-chat-${(new Date).toISOString().slice(0,10)}.txt`,a.click(),URL.revokeObjectURL(s)}clearSession(){this.messages=[],this.sessionId=null;try{localStorage.removeItem("ult-chat-session")}catch{console.warn("Failed to clear session")}this.refs.messages&&(this.refs.messages.innerHTML=""),this.showWelcome(!0),this.updateComposerState()}stopStreaming(){this.abortController?.abort(),this.isStreaming=!1,this.abortController=null,this.updateComposerState(),this.refs.input?.focus()}createThinking(t="Thinking"){const e=this.el("div","ult-thinking",`<span class="ult-thinking-word">${t}</span><span class="ult-typing"><span></span><span></span><span></span></span><span class="ult-thinking-time">(0.0s)</span>`),s=this.qs(".ult-thinking-time",e),a=performance.now(),i=setInterval(()=>{s&&(s.textContent=`(${((performance.now()-a)/1e3).toFixed(1)}s)`)},100);return{el:e,clear:()=>clearInterval(i)}}async performSearch(t){if(!this.refs.messages)return;this.refs.messages.innerHTML="";const{el:e,clear:s}=this.createThinking("Searching");this.refs.messages.appendChild(e);try{const a=this.apiUrl.replace(/\/chat$/,"/search"),i=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:t})});if(!i.ok)throw new Error(`HTTP ${i.status}`);const n=await i.json();if(s(),e.remove(),!n.results?.length)return void(this.refs.messages.innerHTML='<div class="ult-message">No results found. Try different keywords.</div>');this.refs.messages.innerHTML=n.results.map(t=>{const e=t.text?.length>150?t.text.slice(0,150)+"...":t.text||"",s=(()=>{try{return new URL(t.url).hostname}catch{return""}})(),a=s?`https://www.google.com/s2/favicons?sz=32&domain=${encodeURIComponent(s)}`:"",i=a?`<img class="ult-search-result-favicon" src="${a}" alt="" loading="lazy" />`:"",n=s?`<span>${this.escapeHtml(s)}</span>`:"";return`\n          <div class="ult-search-result">\n            <div class="ult-search-result-title">${i}<a href="${this.escapeHtml(t.url)}" target="_blank" rel="noopener">${this.escapeHtml(t.title||"")}</a></div>\n            <div class="ult-search-result-snippet">${this.escapeHtml(e)}</div>\n            <div class="ult-search-result-meta"><span class="ult-search-result-score">Match: ${(100*(t.score||0)).toFixed(0)}%</span>${n}</div>\n          </div>`}).join("")}catch(t){s(),e.remove(),this.refs.messages&&(this.refs.messages.innerHTML=`<div class="ult-message">Search error: ${this.escapeHtml(t.message)}</div>`),console.error("Search error:",t)}}async sendMessage(t){if(!t||this.isStreaming||!this.refs.input||!this.refs.messages)return;if(this.showWelcome(!1),this.autoScroll=!0,"search"===this.mode)return this.refs.input.value=t,this.refs.input.style.height="auto",this.refs.input.style.height=Math.min(this.refs.input.scrollHeight,140)+"px",await this.performSearch(t),void this.refs.input.focus();this.messages.push({role:"user",content:t}),this.addMessageToUI("user",t),this.refs.input.value="",this.refs.input.style.height="auto",this.isStreaming=!0,this.updateComposerState();const e=this.createMessageGroup("assistant"),{el:s,clear:a}=this.createThinking();e.appendChild(s),this.scrollToBottom(),this.abortController=new AbortController;try{const i=await fetch(this.apiUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:[{role:"user",content:t}],session_id:this.sessionId,context:this.getPageContext()}),signal:this.abortController.signal});if(!i.ok)throw new Error(`HTTP ${i.status}`);const n=i.headers.get("X-Session-ID");n&&!this.sessionId&&(this.sessionId=n,this.saveSessionId(n)),s.remove(),a();const o=this.el("div","ult-message assistant");e.appendChild(o);const r=i.body?.getReader();if(!r)throw new Error("No response stream");const l=new TextDecoder;let h="",c=null;const d=()=>{c||(c=setTimeout(()=>{o.innerHTML=this.renderMarkdown(h),this.scrollToBottom(),c=null},30))};for(;;){const{done:t,value:e}=await r.read();if(t)break;const s=l.decode(e,{stream:!0});for(const t of s.split("\n")){if(!t.startsWith("data: "))continue;const e=t.slice(6);if("[DONE]"!==e)try{const t=JSON.parse(e);if(t.content)h+=t.content,d();else if(t.error)throw new Error(t.error)}catch(t){"Unexpected end of JSON input"!==t.message&&console.error("Parse error:",t)}}}c&&(clearTimeout(c),c=null),o.innerHTML=this.renderMarkdown(h),this.scrollToBottom(),this.messages.push({role:"assistant",content:h})}catch(t){s.remove(),a();const i=this.el("div","ult-message assistant","AbortError"===t.name?"Generation stopped.":"Sorry, I encountered an error. Please try again.");e.appendChild(i),console.error("Chat error:",t)}finally{this.isStreaming=!1,this.abortController=null,this.updateComposerState(),this.refs.input?.focus()}}createMessageGroup(t){if(!this.refs.messages)return null;const{name:e,logomark:s}=this.config.branding,a=this.el("div","ult-message-group"),i=this.el("div","ult-message-label","assistant"===t?`<img src="${this.escapeHtml(s)}" alt="${this.escapeHtml(e)}" /><span>${this.escapeHtml(e)}</span>`:'<span class="ult-user-icon"><svg width="29" height="29" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg></span><span>You</span>');return a.appendChild(i),this.refs.messages.appendChild(a),this.scrollToBottom(),a}addMessageToUI(t,e){const s=this.createMessageGroup(t);if(!s)return null;const a=this.el("div","ult-message "+("assistant"===t?"assistant":""),this.renderMarkdown(e));return s.appendChild(a),a}escapeHtml(t){const e=this.el("div");return e.textContent=t,e.innerHTML}renderMarkdown(t){const e=t=>t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),s=(t||"").replace(/\r\n?/g,"\n").split("\n");let a="",i=!1,n="",o=null,r=!1,l=!1,h=!1;const c=()=>{h&&(a+="</p>",h=!1)},d=()=>{h||(a+="<p>",h=!0)},p=()=>{r&&(a+="ol"===o?"</ol>":"</ul>",r=!1,o=null)},u=()=>{l&&(a+="</blockquote>",l=!1)};for(let t of s){const s=t.match(/^\s*```(\w+)?\s*$/);if(s){i?(a+="</code></pre>",i=!1):(c(),p(),u(),i=!0,n=s[1]||"",a+=`<pre><code class="lang-${e(n)}">`);continue}if(i){a+=e(t)+"\n";continue}const h=/^>\s?(.*)$/.exec(t);let m;h?(l||(c(),p(),a+="<blockquote>",l=!0),t=h[1]):u(),(m=t.match(/^\s*([-*+])\s+(.+)$/))?(r&&"ul"===o||(c(),p(),a+="<ul>",r=!0,o="ul"),a+=`<li>${this.renderInline(m[2])}</li>`):(m=t.match(/^\s*(\d+)\.\s+(.+)$/))?(r&&"ol"===o||(c(),p(),a+="<ol>",r=!0,o="ol"),a+=`<li>${this.renderInline(m[2])}</li>`):/^\s*$/.test(t)?(c(),p(),u()):(m=t.match(/^###\s+(.+)$/))?(c(),p(),u(),a+=`<h3>${this.renderInline(m[1])}</h3>`):(m=t.match(/^##\s+(.+)$/))?(c(),p(),u(),a+=`<h2>${this.renderInline(m[1])}</h2>`):(m=t.match(/^#\s+(.+)$/))?(c(),p(),u(),a+=`<h1>${this.renderInline(m[1])}</h1>`):(d(),a+=this.renderInline(t))}return c(),p(),u(),a}renderInline(t){if(!t)return"";t=this.escapeHtml(t);const e=[];return(t=(t=(t=(t=(t=(t=(t=(t=t.replace(/`([^`]+)`/g,(t,s)=>(e.push(s),`@@ULTCODE${e.length-1}@@`))).replace(/\[([^\]]+)]\((https?:\/\/[^\s)]+)\)/g,(t,e,s)=>`<a href="${s}" target="_blank" rel="noopener noreferrer">${e}</a>`)).replace(/(?<!href=")(?<!src=")(?<!>)\b(https?:\/\/[^\s<>'")\]]+?)(?=[.,;:!?]*(?:\s|<|'|"|\)|]|$))/g,t=>`<a href="${t}" target="_blank" rel="noopener noreferrer">${t}</a>`)).replace(/\*\*([^"]+?)\*\*/g,"<strong>$1</strong>")).replace(/__([^"]+?)__/g,"<strong>$1</strong>")).replace(/(?<!\*)\*(?!\*)([^"]+?)\*(?!\*)/g,"<em>$1</em>")).replace(/(?<!_)_(?!_)([^"]+?)_(?!_)/g,"<em>$1</em>")).replace(/@@ULTCODE(\d+)@@/g,(t,s)=>`<code>${e[s]}</code>`)).replace(/ {2}\n/g,"<br>")}}