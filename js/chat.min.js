class UltralyticsChat{constructor(e={}){this.config={apiUrl:e.apiUrl||"/api/chat",maxMessageLength:e.maxMessageLength||1e4,branding:{name:e.branding?.name||"AI",tagline:e.branding?.tagline||"Ask anything about Ultralytics, YOLO, and more",logo:e.branding?.logo||"https://cdn.prod.website-files.com/680a070c3b99253410dd3dcf/680a070c3b99253410dd3e13_logo.svg",logomark:e.branding?.logomark||"https://storage.googleapis.com/organization-image-assets/ultralytics-botAvatarSrcUrl-1729379860806.svg",pillText:e.branding?.pillText||"Ask AI"},theme:{primary:e.theme?.primary||"#042AFF",dark:e.theme?.dark||"#111F68",yellow:e.theme?.yellow||"#E1FF25",text:e.theme?.text||"#0b0b0f"},welcome:{title:e.welcome?.title||"Hi!",message:e.welcome?.message||"I'm an AI assistant trained on documentation, help articles, and other content.<br>Ask me anything about Ultralytics.",examples:e.welcome?.examples||["What's new in YOLO11?","How do I get started with YOLO?","Tell me about Enterprise Licensing"]},ui:{placeholder:e.ui?.placeholder||"Ask anything…",copyText:e.ui?.copyText||"Copy thread",downloadText:e.ui?.downloadText||"Download thread",clearText:e.ui?.clearText||"New chat"}},this.apiUrl=this.config.apiUrl,this.messages=[],this.isOpen=!1,this.isStreaming=!1,this.abortController=null,this.sessionId=this.loadSessionId(),this.autoScroll=!0,this.mode="chat",this.refs={},this.listeners=new Map,this.inputDebounceTimer=null,this.init()}qs=(e,t=document)=>t.querySelector(e);qsa=(e,t=document)=>[...t.querySelectorAll(e)];on(e,t,s){e&&(e.addEventListener(t,s),this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push({ev:t,fn:s}))}el(e,t="",s=""){const a=document.createElement(e);return t&&(a.className=t),s&&(a.innerHTML=s),a}loadSessionId(){try{return localStorage.getItem("ult-chat-session")}catch{return null}}saveSessionId(e){try{localStorage.setItem("ult-chat-session",e)}catch(e){console.warn("Failed to save session ID:",e)}}init(){this.createStyles(),this.createUI(),this.attachEvents(),this.syncThemeWithSite(),this.showWelcome(!0),this.updateComposerState()}destroy(){this.toggle(!1),this.inputDebounceTimer&&(clearTimeout(this.inputDebounceTimer),this.inputDebounceTimer=null),this.listeners.forEach((e,t)=>{e.forEach(({ev:e,fn:s})=>t.removeEventListener(e,s))}),this.listeners.clear(),this.styleElement?.remove(),this.refs.modal?.remove(),this.refs.backdrop?.remove(),this.refs.pill?.remove(),this.refs={}}syncThemeWithSite(){const e=document.documentElement,t=window.matchMedia("(prefers-color-scheme: dark)"),s=()=>{e.hasAttribute("data-theme")||e.setAttribute("data-theme",t.matches?"dark":"light")};s();const a=()=>s();t.addEventListener?t.addEventListener("change",a):t.addListener&&t.addListener(a)}createStyles(){const{primary:e,dark:t,yellow:s,text:a}=this.config.theme;this.styleElement=this.el("style","",`\n      *{box-sizing:border-box}\n      :root{--ult-dark:${t};--ult-primary:${e};--ult-yellow:${s};--ult-text:${a}}\n\n      .ult-backdrop{display:none;position:fixed;inset:0;background:rgba(255,255,255,.07);\n        backdrop-filter:blur(3px) saturate(120%) brightness(1.025);-webkit-backdrop-filter:blur(3px) saturate(120%) brightness(1.025);\n        z-index:9999;opacity:0;transition:opacity .18s}\n      .ult-backdrop.open{display:block;opacity:1}\n\n      .ultralytics-chat-pill{position:fixed;right:16px;bottom:36px;padding:14px 22px;border-radius:9999px;background:var(--ult-yellow);\n        color:var(--ult-dark);border:0;cursor:pointer;font-size:18px;font-weight:500;box-shadow:0 20px 38px rgba(2,6,23,.22),0 8px 18px rgba(2,6,23,.14);\n        z-index:10000;transition:transform .18s,box-shadow .18s,opacity .14s;display:inline-flex;align-items:center;gap:10px;transform:translateZ(0);\n        -webkit-user-select:none;user-select:none}\n      .ultralytics-chat-pill:hover{transform:scale(1.1)} .ultralytics-chat-pill.hidden{transform:scale(.95);opacity:0;pointer-events:none}\n      .ultralytics-chat-pill img{width:30px;height:30px;border-radius:3px}\n      html[data-theme=dark] .ultralytics-chat-pill{background:#40434f;color:#fff;box-shadow:0 20px 38px rgba(0,0,0,.5),0 8px 18px rgba(0,0,0,.32)}\n\n      .ult-chat-modal{position:fixed;left:50%;top:50%;width:min(760px,calc(100vw - 40px));height:min(80vh,820px);background:#fff;border:0;border-radius:16px;\n        box-shadow:0 24px 60px rgba(2,6,23,.25),0 8px 24px rgba(2,6,23,.18);z-index:10001;transform:translate(-50%,-50%) scale(.98);opacity:0;transition:transform .18s,opacity .18s;\n        flex-direction:column;overflow:hidden;text-align:left;display:none}\n      .ult-chat-modal.open{display:flex;opacity:1;transform:translate(-50%,-50%) scale(1)}\n      html[data-theme=dark] .ult-chat-modal{background:#0a0a0b}\n\n      .ult-chat-header{padding:16px 18px;display:flex;justify-content:space-between;align-items:center}\n      .ult-chat-title{display:flex;align-items:center;gap:10px}\n      .ult-chat-title img{max-height:32px;max-width:180px}\n      .ult-subtle{font-size:12px;color:#6b7280} html[data-theme=dark] .ult-subtle{color:#a1a1aa}\n      .ult-header-actions{display:flex;gap:6px;align-items:center}\n      .ult-icon-btn{background:transparent;border:0;width:44px;height:44px;border-radius:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;color:#6b7280;transition:.15s}\n      .ult-icon-btn:hover{transform:translateY(-1px);color:var(--ult-text);background:#f7f7f9}\n      html[data-theme=dark] .ult-icon-btn{color:#a1a1aa}\n      html[data-theme=dark] .ult-icon-btn:hover{color:#fafafa;background:#17181d}\n\n      .ult-welcome{padding:18px}.ult-welcome h1{font-size:16px;margin:0 0 6px}.ult-welcome p{margin:0;color:#4b5563}\n      html[data-theme=dark] .ult-welcome p{color:#a1a1aa}\n      .ult-examples{padding:12px 18px 6px;display:flex;flex-wrap:wrap;gap:10px}\n      .ult-example{padding:10px 12px;background:#f7f7f9;border:0;border-radius:999px;cursor:pointer;font-size:12px;color:#0b0b0f;transition:.12s}\n      .ult-example:hover{transform:translateY(-1px);filter:brightness(.98)}\n      html[data-theme=dark] .ult-example{background:#131318;color:#fafafa}\n\n      .ult-chat-messages{flex:1;overflow-y:auto;padding:0 18px 18px;display:flex;flex-direction:column;gap:14px;-webkit-overflow-scrolling:touch}\n      .ult-message-group{display:flex;flex-direction:column;gap:6px}\n      .ult-message-label{display:flex;align-items:center;gap:8px;font-size:11px;font-weight:800;color:#6b7280;text-transform:uppercase;letter-spacing:.03em;padding:0 2px}\n      html[data-theme=dark] .ult-message-label{color:#a1a1aa}\n      .ult-message-label img{max-height:24px;max-width:24px;border-radius:4px}\n      .ult-user-icon{color:var(--ult-yellow)}\n      .ult-message{font-size:14px;line-height:1.6;color:var(--ult-text);padding:0 2px;word-break:break-word;text-align:left}\n      html[data-theme=dark] .ult-message{color:#f5f5f5}\n      .ult-message a{color:var(--ult-primary);text-underline-offset:2px}.ult-message a:hover{text-decoration:underline}\n      .ult-message pre{background:#0f172a;color:#e5e7eb;padding:10px 12px;border-radius:10px;overflow:auto;margin:6px 0;border:0}\n      .ult-message code{background:#f4f4f5;padding:2px 6px;border-radius:6px;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:12px;border:0}\n      .ult-message pre code{background:transparent;padding:0;border:0;display:block;color:inherit;font-size:13px}\n      html[data-theme=dark] .ult-message code{background:#1e1e22}\n      html[data-theme=dark] .ult-message pre code{background:transparent}\n\n      .ult-search-result{padding:14px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;margin-bottom:10px;transition:.12s}\n      .ult-search-result:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(2,6,23,.08)}\n      html[data-theme=dark] .ult-search-result{background:#131318;border-color:#232327}\n      .ult-search-result-title{font-size:15px;font-weight:700;margin-bottom:6px;display:flex;align-items:center;gap:8px}\n      .ult-search-result-title a{text-decoration:none;color:var(--ult-primary)}\n      .ult-search-result-favicon{width:18px;height:18px;border-radius:4px;flex-shrink:0;background:#f4f4f5;box-shadow:0 0 0 1px rgba(0,0,0,.05)}\n      html[data-theme=dark] .ult-search-result-favicon{background:#1f1f25;box-shadow:0 0 0 1px rgba(255,255,255,.06)}\n      .ult-search-result-snippet{font-size:13px;line-height:1.5;color:#4b5563;margin-bottom:8px}\n      html[data-theme=dark] .ult-search-result-snippet{color:#a1a1aa}\n      .ult-search-result-meta{display:flex;gap:12px;font-size:11px;color:#9ca3af} html[data-theme=dark] .ult-search-result-meta{color:#71717a}\n\n      .ult-typing{display:inline-flex;gap:4px}\n      .ult-typing span{width:6px;height:6px;background:#a1a1aa;border-radius:50%;animation:ultTyping 1.2s infinite}\n      .ult-typing span:nth-child(2){animation-delay:.18s}.ult-typing span:nth-child(3){animation-delay:.36s}\n      @keyframes ultTyping{0%,60%,100%{transform:translateY(0);opacity:1}30%{transform:translateY(-6px);opacity:.75}}\n      .ult-thinking{display:inline-flex;align-items:center;gap:8px;padding:6px 0;color:#6b7280;font-size:13px}\n      html[data-theme=dark] .ult-thinking{color:#a1a1aa}\n\n      .ult-chat-input-container{padding:12px 12px 16px;display:flex;gap:8px;align-items:flex-end}\n      .ult-actions{display:flex;gap:6px;align-items:center}\n      .ult-action-btn,.ult-chat-send{background:#f1f2f6;border:0;border-radius:12px;width:44px;height:44px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:.12s;flex-shrink:0}\n      .ult-action-btn:hover,.ult-chat-send:hover{transform:translateY(-1px);filter:brightness(.98)}\n      html[data-theme=dark] .ult-action-btn,html[data-theme=dark] .ult-chat-send{background:#17181d}\n      .ult-chat-input{flex:1;padding:10px 12px;border:0;border-radius:12px;font-size:16px;resize:none;max-height:140px;background:#f7f7f9;color:#0b0b0f;outline:0}\n      .ult-chat-input::placeholder{color:#9ca3af} html[data-theme=dark] .ult-chat-input{background:#131318;color:#fafafa}\n\n      .ult-chat-modal[data-mode="search"] .ult-chat-header{order:0}\n      .ult-chat-modal[data-mode="search"] .ult-chat-input-container{order:1;padding:16px 18px;border-top:1px solid #eceff5;border-bottom:1px solid #eceff5;background:#fdfdff;align-items:center}\n      html[data-theme=dark] .ult-chat-modal[data-mode="search"] .ult-chat-input-container{border-color:#1c1c22;background:#0e0e13}\n      .ult-chat-modal[data-mode="search"] #ult-welcome,\n      .ult-chat-modal[data-mode="search"] #ult-examples{order:2;width:100%}\n      .ult-chat-modal[data-mode="search"] .ult-chat-messages{order:3}\n\n      .ult-icon-swap{display:flex;align-items:center;justify-content:center}\n      @media (max-width:768px){.ult-backdrop{pointer-events:none}.ult-chat-modal{left:0;top:0;transform:none;width:100vw;height:100vh;border-radius:0;pointer-events:auto;padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left)}.ult-chat-modal.open{transform:none}.ult-actions{display:none}.ult-chat-header{padding:12px 18px}.ult-chat-input-container{padding-bottom:max(16px,env(safe-area-inset-bottom))}}\n    `),document.head.appendChild(this.styleElement)}icon(e){return`<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">${{copy:'<rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>',download:'<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>',refresh:'<path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>',close:'<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>',like:'<path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/>',dislike:'<path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h2.67A2.31 2.31 0 0 1 22 4v7a2.31 2.31 0 0 1-2.33 2H17"/>',share:'<circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><path d="M8.59 13.51l6.83 3.98"/><path d="M15.41 6.51L8.59 10.49"/>',arrowUp:'<line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/>',square:'<rect x="6" y="6" width="12" height="12" rx="2" ry="2"/>'}[e]||""}</svg>`}createUI(){const{logomark:e,pillText:t,logo:s,name:a,tagline:i}=this.config.branding,{title:n,message:r,examples:o}=this.config.welcome,{placeholder:l,copyText:h,downloadText:c,clearText:d}=this.config.ui;this.refs.backdrop=this.el("div","ult-backdrop"),document.body.appendChild(this.refs.backdrop),this.refs.pill=this.el("button","ultralytics-chat-pill",`<span>${this.escapeHtml(t)}</span><img src="${this.escapeHtml(e)}" alt="${this.escapeHtml(a)}" />`),this.refs.pill.setAttribute("aria-label",t),this.refs.pill.title=t,document.body.appendChild(this.refs.pill),this.refs.modal=this.el("div","ult-chat-modal",`\n      <div class="ult-chat-header">\n        <div class="ult-chat-title">\n          <img src="${this.escapeHtml(s)}" alt="${this.escapeHtml(a)}" />\n          <div class="ult-subtle">${this.escapeHtml(i)}</div>\n        </div>\n        <div class="ult-header-actions">\n          <button class="ult-icon-btn ult-chat-copy" title="${this.escapeHtml(h)}" aria-label="${this.escapeHtml(h)}">${this.icon("copy")}</button>\n          <button class="ult-icon-btn ult-chat-download" title="${this.escapeHtml(c)}" aria-label="${this.escapeHtml(c)}">${this.icon("download")}</button>\n          <button class="ult-icon-btn ult-chat-clear" title="${this.escapeHtml(d)}" aria-label="${this.escapeHtml(d)}">${this.icon("refresh")}</button>\n          <button class="ult-icon-btn ult-chat-close" title="Close" aria-label="Close">${this.icon("close")}</button>\n        </div>\n      </div>\n\n      <div id="ult-welcome" class="ult-welcome" style="display:none">\n        <h1>${this.escapeHtml(n)}</h1><p>${r}</p>\n      </div>\n\n      <div id="ult-examples" class="ult-examples" style="display:none"></div>\n\n      <div class="ult-chat-messages" id="ult-messages" aria-live="polite"></div>\n\n      <div class="ult-chat-input-container">\n        <div class="ult-actions">\n          <button class="ult-action-btn ult-act-copy" title="Copy last response" aria-label="Copy last response">${this.icon("copy")}</button>\n          <button class="ult-action-btn ult-act-like" title="Thumbs up" aria-label="Thumbs up">${this.icon("like")}</button>\n          <button class="ult-action-btn ult-act-dislike" title="Thumbs down" aria-label="Thumbs down">${this.icon("dislike")}</button>\n          <button class="ult-action-btn ult-act-share" title="Share" aria-label="Share">${this.icon("share")}</button>\n          <button class="ult-action-btn ult-act-retry" title="Try again" aria-label="Try again">${this.icon("refresh")}</button>\n        </div>\n        <textarea class="ult-chat-input" placeholder="${this.escapeHtml(l)}" rows="1" maxlength="${this.config.maxMessageLength}"></textarea>\n        <button class="ult-chat-send" title="Ready" aria-label="Ready">\n          <span class="ult-icon-swap" data-icon="square">${this.icon("square")}</span>\n        </button>\n      </div>\n    `),this.refs.modal.setAttribute("role","dialog"),this.refs.modal.setAttribute("aria-modal","true"),document.body.appendChild(this.refs.modal),this.refs.messages=this.qs("#ult-messages",this.refs.modal),this.refs.welcome=this.qs("#ult-welcome",this.refs.modal),this.refs.examples=this.qs("#ult-examples",this.refs.modal),this.refs.input=this.qs(".ult-chat-input",this.refs.modal),this.refs.send=this.qs(".ult-chat-send",this.refs.modal),this.setExamples(o)}setExamples(e){this.refs.examples&&(this.refs.examples.innerHTML=e.map(e=>`<button class="ult-example" data-q="${this.escapeHtml(e)}">${this.escapeHtml(e)}</button>`).join(""),this.qsa(".ult-example",this.refs.examples).forEach(e=>this.on(e,"click",()=>this.sendMessage(e.dataset.q))))}attachEvents(){const e=this.refs.modal;this.on(this.refs.pill,"click",()=>this.toggle(!0,"chat")),this.on(this.refs.backdrop,"click",()=>this.toggle()),this.on(this.qs(".ult-chat-close",e),"click",()=>this.toggle()),this.on(this.qs(".ult-chat-clear",e),"click",()=>this.clearSession()),this.on(this.qs(".ult-chat-copy",e),"click",()=>this.copyThread()),this.on(this.qs(".ult-chat-download",e),"click",()=>this.downloadThread()),this.on(this.refs.messages,"scroll",()=>{const e=this.refs.messages;this.autoScroll=e.scrollHeight-e.scrollTop-e.clientHeight<100}),this.on(this.refs.input,"input",e=>{const t=e.target;t.style.height="auto",t.style.height=Math.min(t.scrollHeight,140)+"px",this.inputDebounceTimer&&clearTimeout(this.inputDebounceTimer),this.inputDebounceTimer=setTimeout(()=>this.updateComposerState(),50)}),this.on(this.refs.send,"click",()=>{this.isStreaming?this.stopStreaming():this.sendMessage(this.refs.input.value.trim())}),this.on(this.refs.input,"keydown",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this.sendMessage(this.refs.input.value.trim())),"Escape"===e.key&&(e.preventDefault(),this.toggle(!1))}),this.on(document,"keydown",e=>{this.isOpen&&"Escape"===e.key&&this.toggle(!1),!this.isOpen&&e.metaKey&&"k"===e.key.toLowerCase()&&this.toggle(!0)}),this.on(this.qs(".ult-act-copy",e),"click",()=>this.copyLastAssistant()),this.on(this.qs(".ult-act-like",e),"click",()=>this.feedback("up")),this.on(this.qs(".ult-act-dislike",e),"click",()=>this.feedback("down")),this.on(this.qs(".ult-act-share",e),"click",()=>this.copyThread()),this.on(this.qs(".ult-act-retry",e),"click",()=>this.retryLast())}toggle(e=null,t=null){const s=null===e?!this.isOpen:!!e;this.isOpen=s,t&&(this.mode=t),this.refs.modal?.classList.toggle("open",s),this.refs.backdrop?.classList.toggle("open",s),this.refs.pill?.classList.toggle("hidden",s),document.documentElement.style.overflow=s?"hidden":"",s?(this.updateUIForMode(),this.messages.length||this.showWelcome(!0),this.refs.input?.focus(),this.updateComposerState()):this.isStreaming&&this.stopStreaming()}updateUIForMode(){if(!this.refs.modal)return;const e=this.qs(".ult-subtle",this.refs.modal);if(this.refs.modal.dataset.mode=this.mode,"search"===this.mode){this.refs.input&&(this.refs.input.placeholder="Search for..."),e&&(e.innerHTML=`<strong style="color: ${this.config.theme.primary}; font-weight: 700;">SEARCH</strong> · Find answers in our docs and guides`);const t=this.qs(".ult-actions",this.refs.modal);t&&(t.style.display="none"),this.refs.messages&&(this.refs.messages.innerHTML=""),this.refs.welcome&&(this.refs.welcome.innerHTML="<p>Enter keywords to find relevant documentation, guides, and resources</p>"),this.setExamples(["YOLO quickstart","model training parameters","export formats","dataset configuration"]),this.showWelcome(!0)}else{this.refs.input&&(this.refs.input.placeholder=this.config.ui.placeholder),e&&(e.textContent=this.config.branding.tagline);const t=this.qs(".ult-actions",this.refs.modal);t&&(t.style.display="");const{title:s,message:a,examples:i}=this.config.welcome;this.refs.welcome&&(this.refs.welcome.innerHTML=`<h1>${this.escapeHtml(s)}</h1><p>${a}</p>`),this.setExamples(i),this.renderChatHistory()}}showWelcome(e){this.refs.welcome&&(this.refs.welcome.style.display=e?"block":"none"),this.refs.examples&&(this.refs.examples.style.display=e?"flex":"none")}renderChatHistory(){if(!this.refs.messages)return;if(this.refs.messages.innerHTML="",!this.messages.length)return void this.showWelcome(!0);this.showWelcome(!1);const e=this.autoScroll;this.autoScroll=!1,this.messages.forEach(e=>this.addMessageToUI(e.role,e.content)),this.autoScroll=e,this.refs.messages.scrollTop=this.refs.messages.scrollHeight}swapSendIcon(e){const t=this.qs(".ult-icon-swap",this.refs.send);t&&t.dataset.icon!==e&&(t.innerHTML=this.icon(e),t.dataset.icon=e,this.refs.send.title="square"===e&&this.isStreaming?"Stop":"arrowUp"===e?"Send":"Ready",this.refs.send.setAttribute("aria-label",this.refs.send.title))}updateComposerState(){const e=!!this.refs.input?.value.trim().length;this.isStreaming?this.swapSendIcon("square"):this.swapSendIcon(e?"arrowUp":"square")}scrollToBottom(){this.autoScroll&&this.refs.messages&&requestAnimationFrame(()=>{this.refs.messages&&(this.refs.messages.scrollTop=this.refs.messages.scrollHeight)})}formatThread(){return this.messages.map(e=>`${"user"===e.role?"You":this.config.branding.name}: ${e.content}`).join("\n\n---\n\n")}copyThread(){navigator.clipboard?.writeText&&navigator.clipboard.writeText(this.formatThread()).catch(console.error)}copyLastAssistant(){const e=[...this.messages].reverse().find(e=>"assistant"===e.role);e&&navigator.clipboard?.writeText&&navigator.clipboard.writeText(e.content).catch(console.error)}feedback(e){console.log("feedback:",e)}retryLast(){const e=[...this.messages].reverse().find(e=>"user"===e.role);e&&this.sendMessage(e.content)}downloadThread(){const{name:e}=this.config.branding,t=new Blob([this.formatThread()],{type:"text/plain"}),s=URL.createObjectURL(t),a=this.el("a");a.href=s,a.download=`${e.toLowerCase().replace(/\s+/g,"-")}-chat-${(new Date).toISOString().slice(0,10)}.txt`,a.click(),URL.revokeObjectURL(s)}clearSession(){this.messages=[],this.sessionId=null;try{localStorage.removeItem("ult-chat-session")}catch(e){console.warn("Failed to clear session:",e)}this.refs.messages&&(this.refs.messages.innerHTML=""),this.showWelcome(!0),this.updateComposerState()}stopStreaming(){this.abortController&&this.abortController.abort(),this.isStreaming=!1,this.abortController=null,this.updateComposerState(),this.refs.input?.focus()}createThinking(e="Thinking"){const t=this.el("div","ult-thinking",`<span class="ult-thinking-word">${e}</span><span class="ult-typing"><span></span><span></span><span></span></span><span class="ult-thinking-time">(0.0s)</span>`),s=this.qs(".ult-thinking-time",t),a=performance.now(),i=setInterval(()=>{s&&(s.textContent=`(${((performance.now()-a)/1e3).toFixed(1)}s)`)},100);return{el:t,clear:()=>clearInterval(i)}}async performSearch(e){if(!this.refs.messages)return;this.refs.messages.innerHTML="";const{el:t,clear:s}=this.createThinking("Searching");this.refs.messages.appendChild(t);try{const a=this.apiUrl.replace(/\/chat$/,"/search"),i=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:e})});if(!i.ok)throw new Error(`HTTP ${i.status}`);const n=await i.json();if(s(),t.remove(),!n.results?.length)return void(this.refs.messages.innerHTML='<div class="ult-message">No results found. Try different keywords.</div>');this.refs.messages.innerHTML=n.results.map(e=>{const t=e.text?.length>150?e.text.slice(0,150)+"...":e.text||"";let s="";try{s=new URL(e.url).hostname}catch{s=""}const a=s?`https://www.google.com/s2/favicons?sz=32&domain=${encodeURIComponent(s)}`:"",i=a?`<img class="ult-search-result-favicon" src="${a}" alt="" loading="lazy" />`:"",n=s?`<span>${this.escapeHtml(s)}</span>`:"";return`\n          <div class="ult-search-result">\n            <div class="ult-search-result-title">${i}<a href="${this.escapeHtml(e.url)}" target="_blank" rel="noopener">${this.escapeHtml(e.title||"")}</a></div>\n            <div class="ult-search-result-snippet">${this.escapeHtml(t)}</div>\n            <div class="ult-search-result-meta"><span class="ult-search-result-score">Match: ${(100*(e.score||0)).toFixed(0)}%</span>${n}</div>\n          </div>`}).join("")}catch(e){s(),t.remove(),this.refs.messages&&(this.refs.messages.innerHTML=`<div class="ult-message">Search error: ${this.escapeHtml(e.message)}</div>`),console.error("Search error:",e)}}async sendMessage(e){if(!e||this.isStreaming||!this.refs.input||!this.refs.messages)return;if(this.showWelcome(!1),this.autoScroll=!0,"search"===this.mode)return this.refs.input.value=e,this.refs.input.style.height="auto",this.refs.input.style.height=Math.min(this.refs.input.scrollHeight,140)+"px",await this.performSearch(e),void this.refs.input.focus();this.messages.push({role:"user",content:e}),this.addMessageToUI("user",e),this.refs.input.value="",this.refs.input.style.height="auto",this.isStreaming=!0,this.updateComposerState();const t=this.createMessageGroup("assistant"),{el:s,clear:a}=this.createThinking();t.appendChild(s),this.scrollToBottom(),this.abortController=new AbortController;try{const i=await fetch(this.apiUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:[{role:"user",content:e}],session_id:this.sessionId}),signal:this.abortController.signal});if(!i.ok)throw new Error(`HTTP ${i.status}`);const n=i.headers.get("X-Session-ID");n&&!this.sessionId&&(this.sessionId=n,this.saveSessionId(n)),s.remove(),a();const r=this.el("div","ult-message assistant");t.appendChild(r);const o=i.body?.getReader();if(!o)throw new Error("No response stream");const l=new TextDecoder;let h="",c=null;const d=30,p=()=>{c||(c=setTimeout(()=>{r.innerHTML=this.renderMarkdown(h),this.scrollToBottom(),c=null},d))};for(;;){const{done:e,value:t}=await o.read();if(e)break;const s=l.decode(t,{stream:!0});for(const e of s.split("\n")){if(!e.startsWith("data: "))continue;const t=e.slice(6);if("[DONE]"!==t)try{const e=JSON.parse(t);if(e.content)h+=e.content,p();else if(e.error)throw new Error(e.error)}catch(e){"Unexpected end of JSON input"!==e.message&&console.error("Parse error:",e)}}}c&&(clearTimeout(c),c=null),r.innerHTML=this.renderMarkdown(h),this.scrollToBottom(),this.messages.push({role:"assistant",content:h})}catch(e){s.remove(),a();const i=this.el("div","ult-message assistant","AbortError"===e.name?"Generation stopped.":"Sorry, I encountered an error. Please try again.");t.appendChild(i),console.error("Chat error:",e)}finally{this.isStreaming=!1,this.abortController=null,this.updateComposerState(),this.refs.input?.focus()}}createMessageGroup(e){if(!this.refs.messages)return null;const{name:t,logomark:s}=this.config.branding,a=this.el("div","ult-message-group"),i=this.el("div","ult-message-label","assistant"===e?`<img src="${this.escapeHtml(s)}" alt="${this.escapeHtml(t)}" /><span>${this.escapeHtml(t)}</span>`:'<span class="ult-user-icon"><svg width="29" height="29" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg></span><span>You</span>');return a.appendChild(i),this.refs.messages.appendChild(a),this.scrollToBottom(),a}addMessageToUI(e,t){const s=this.createMessageGroup(e);if(!s)return null;const a=this.el("div","ult-message "+("assistant"===e?"assistant":""),this.renderMarkdown(t));return s.appendChild(a),a}escapeHtml(e){const t=this.el("div");return t.textContent=e,t.innerHTML}renderMarkdown(e){const t=e=>e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),s=(e||"").replace(/\r\n?/g,"\n").split("\n");let a="",i=!1,n="",r=null,o=!1,l=!1,h=!1;const c=()=>{h&&(a+="</p>",h=!1)},d=()=>{h||(a+="<p>",h=!0)},p=()=>{o&&(a+="ol"===r?"</ol>":"</ul>",o=!1,r=null)},u=()=>{l&&(a+="</blockquote>",l=!1)};for(let e of s){const s=e.match(/^```(\w+)?\s*$/);if(s){i?(a+="</code></pre>",i=!1,n=""):(c(),p(),u(),i=!0,n=s[1]||"",a+=`<pre><code class="lang-${t(n)}">`);continue}if(i){a+=t(e)+"\n";continue}const h=/^>\s?(.*)$/.exec(e);let m;h?(l||(c(),p(),a+="<blockquote>",l=!0),e=h[1]):u(),(m=e.match(/^\s*([-*+])\s+(.+)$/))?(o&&"ul"===r||(c(),p(),a+="<ul>",o=!0,r="ul"),a+=`<li>${this.renderInline(m[2])}</li>`):(m=e.match(/^\s*(\d+)\.\s+(.+)$/))?(o&&"ol"===r||(c(),p(),a+="<ol>",o=!0,r="ol"),a+=`<li>${this.renderInline(m[2])}</li>`):/^\s*$/.test(e)?(c(),p(),u()):(m=e.match(/^###\s+(.+)$/))?(c(),p(),u(),a+=`<h3>${this.renderInline(m[1])}</h3>`):(m=e.match(/^##\s+(.+)$/))?(c(),p(),u(),a+=`<h2>${this.renderInline(m[1])}</h2>`):(m=e.match(/^#\s+(.+)$/))?(c(),p(),u(),a+=`<h1>${this.renderInline(m[1])}</h1>`):(d(),a+=this.renderInline(e))}return c(),p(),u(),a}renderInline(e){return e?(e=(e=(e=(e=(e=(e=this.escapeHtml(e)).replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g,'<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>')).replace(/(?<!["'(])\bhttps?:\/\/[^\s<)]+[^\s<).,;:'")\]]/g,e=>`<a href="${e}" target="_blank" rel="noopener noreferrer">${e}</a>`)).replace(/(\*\*|__)(.*?)\1/g,"<strong>$2</strong>")).replace(/(\*|_)([^*_]+)\1/g,"<em>$2</em>")).replace(/`([^`]+)`/g,"<code>$1</code>")).replace(/ {2}\n/g,"<br>"):""}}